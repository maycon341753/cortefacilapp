<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limpar Service Worker - CorteF√°cil</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">üßπ Limpeza de Service Worker</h4>
                    </div>
                    <div class="card-body">
                        <p>Esta p√°gina ir√° limpar todos os Service Workers que podem estar interferindo com a navega√ß√£o.</p>
                        
                        <div id="status" class="alert alert-info">
                            <strong>Status:</strong> <span id="statusText">Iniciando limpeza...</span>
                        </div>
                        
                        <div id="log" class="mt-3">
                            <h6>Log de Atividades:</h6>
                            <div id="logContent" class="border p-3 bg-light" style="height: 300px; overflow-y: auto;"></div>
                        </div>
                        
                        <div class="mt-3">
                            <button id="btnLimpar" class="btn btn-danger" onclick="limparServiceWorkers()">üóëÔ∏è Limpar Service Workers</button>
                            <button id="btnTestar" class="btn btn-primary" onclick="testarNavegacao()">üîç Testar Navega√ß√£o</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function log(mensagem) {
            const agora = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('logContent');
            const novaLinha = document.createElement('div');
            novaLinha.innerHTML = `<strong>[${agora}]</strong> ${mensagem}`;
            logDiv.appendChild(novaLinha);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(mensagem);
        }
        
        function atualizarStatus(texto, tipo = 'info') {
            const statusDiv = document.getElementById('status');
            const statusText = document.getElementById('statusText');
            statusDiv.className = `alert alert-${tipo}`;
            statusText.textContent = texto;
        }
        
        async function limparServiceWorkers() {
            log('üßπ Iniciando limpeza de Service Workers...');
            atualizarStatus('Limpando Service Workers...', 'warning');
            
            if ('serviceWorker' in navigator) {
                try {
                    // Obter todos os registros de service worker
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    log(`üìã Encontrados ${registrations.length} Service Workers`);
                    
                    if (registrations.length === 0) {
                        log('‚úÖ Nenhum Service Worker encontrado');
                        atualizarStatus('Nenhum Service Worker para limpar', 'success');
                        return;
                    }
                    
                    // Desregistrar todos os service workers
                    for (let registration of registrations) {
                        log(`üóëÔ∏è Removendo Service Worker: ${registration.scope}`);
                        await registration.unregister();
                        log(`‚úÖ Service Worker removido: ${registration.scope}`);
                    }
                    
                    // Limpar cache
                    if ('caches' in window) {
                        const cacheNames = await caches.keys();
                        log(`üì¶ Encontrados ${cacheNames.length} caches`);
                        
                        for (let cacheName of cacheNames) {
                            if (cacheName.includes('vite') || cacheName.includes('cortefacil')) {
                                log(`üóëÔ∏è Removendo cache: ${cacheName}`);
                                await caches.delete(cacheName);
                                log(`‚úÖ Cache removido: ${cacheName}`);
                            }
                        }
                    }
                    
                    log('üéâ Limpeza conclu√≠da com sucesso!');
                    atualizarStatus('Service Workers removidos com sucesso!', 'success');
                    
                    // Recarregar a p√°gina ap√≥s 2 segundos
                    setTimeout(() => {
                        log('üîÑ Recarregando p√°gina...');
                        window.location.reload();
                    }, 2000);
                    
                } catch (error) {
                    log(`‚ùå Erro durante a limpeza: ${error.message}`);
                    atualizarStatus(`Erro: ${error.message}`, 'danger');
                }
            } else {
                log('‚ùå Service Workers n√£o suportados neste navegador');
                atualizarStatus('Service Workers n√£o suportados', 'warning');
            }
        }
        
        function testarNavegacao() {
            log('üîç Testando navega√ß√£o...');
            
            const urls = [
                'https://cortefacil.app/parceiro/dashboard.php',
                'https://cortefacil.app/parceiro/agenda.php',
                'https://cortefacil.app/parceiro/profissionais.php'
            ];
            
            urls.forEach((url, index) => {
                setTimeout(() => {
                    log(`üåê Testando: ${url}`);
                    const link = document.createElement('a');
                    link.href = url;
                    link.target = '_blank';
                    link.textContent = `Teste ${index + 1}`;
                    link.click();
                }, index * 1000);
            });
        }
        
        // Executar limpeza autom√°tica ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            log('üìÑ P√°gina carregada');
            log('üîç Verificando Service Workers...');
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    if (registrations.length > 0) {
                        log(`‚ö†Ô∏è Encontrados ${registrations.length} Service Workers ativos`);
                        registrations.forEach(reg => {
                            log(`üìç Service Worker: ${reg.scope}`);
                        });
                        atualizarStatus(`${registrations.length} Service Workers encontrados`, 'warning');
                    } else {
                        log('‚úÖ Nenhum Service Worker ativo');
                        atualizarStatus('Nenhum Service Worker ativo', 'success');
                    }
                });
            }
        });
    </script>
</body>
</html>